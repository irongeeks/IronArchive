# Story 1.2 – Path to 100/100 Quality Score

**Current Score: 93/100 (Gate: CONCERNS)**  
**Target Score: 100/100 (Gate: EXCELLENT)**

This guide enumerates the remaining follow-ups required to eliminate the open quality concerns for the database migration story. Completing the items below will remove the final medium/low-risk flags, bringing the quality gate to a perfect score.

---

## Overview

| Issue ID   | Priority | Effort | Impact Area  |
|------------|----------|--------|--------------|
| SCHEMA-003 | MEDIUM   | 4 hrs  | Requirements |
| DOC-010    | LOW      | 30 min | Enablement   |

**Estimated Effort: 4.5 hours**

---

## Issue 1 – Reconcile Tenant Credential Contract (SCHEMA-003)

**Impact**: Requirements: 85 → 100  
**Priority**: MEDIUM (acceptance criteria misalignment)  
**Effort**: ~4 hours (including coordination + implementation)

### Problem

The migration stores tenant credentials using two fields (`azure_app_id`, `azure_app_secret`) while Story 1.2 and the Epic PRD specify a single encrypted column `azure_app_credentials` (`docs/stories/1.2.story.md:18`, `docs/prd/epic-1-foundation-core-infrastructure.md:34`). This mismatch leaves the quality gate in **CONCERNS** status because downstream services may rely on the contract defined in the story/PRD.

Architecture documentation currently mirrors the dual-column design (`docs/architecture/database-schema.md:32`). To reach 100/100 we need the product contract and the implementation to agree.

### Resolution Options

Choose **one** of the following with Product/Architecture sign-off:

1. **Align Implementation to Story Contract (preferred for this story)**  
   - Update the migration to replace `azure_app_id` and `azure_app_secret` with a single `azure_app_credentials TEXT` column encrypted via pgcrypto.
   - Adjust the down migration accordingly.
   - Update database tests that insert/send tenant credentials (`backend/internal/database/schema_test.go:186`, `:222`, `:249`) to match the new column name.
   - Provide helper routines (if needed) to pack/unpack the credential payload; a simple JSON blob works well:
     ```sql
     INSERT INTO tenants (name, azure_tenant_id, azure_app_credentials)
     VALUES ($1, $2, pgp_sym_encrypt($3, $4));
     ```
   - Add/extend tests to confirm encrypted storage and the ability to decrypt back the JSON fields expected by business logic.
   - Reflect the schema change in architecture docs (`docs/architecture/database-schema.md`, `docs/architecture/backend-architecture.md`) and any API specs relying on split fields.

2. **Update Story/PRD to Match the Dual-Column Design**  
   - Coordinate with the Product Owner to update `docs/stories/1.2.story.md` acceptance criteria and Epic documentation so they explicitly call for `azure_app_id` + `azure_app_secret`.
   - Ensure any dependent stories/epics (e.g., credential verification flows in `docs/prd/epic-2-tenant-mailbox-management.md`) remain coherent.
   - Capture the decision in the story’s Change Log so QA can trace the contract change.

> ⚠️ Whichever option is chosen, document the decision in `docs/stories/1.2.story.md` under Dev Notes or Change Log for traceability.

### Verification Checklist

- [ ] Migration up/down succeeds on a fresh database (`make migrate-up`, `make migrate-down`).  
- [ ] All schema tests pass (`backend/internal/database/schema_test.go`, `migrations_test.go`).  
- [ ] Documentation updated to reflect the canonical column contract.  
- [ ] QA gate re-run confirms AC-4 is satisfied with no residual concerns.

---

## Issue 2 – Document Database Test Prerequisites (DOC-010)

**Impact**: Enablement: 90 → 100  
**Priority**: LOW  
**Effort**: ~30 minutes

### Problem

Running the database test suite requires:
- A reachable PostgreSQL instance (default: `postgres://ironarchive:ironarchive_password@localhost:5432/ironarchive?sslmode=disable`)
- The `migrate` CLI available on the developer’s PATH

These prerequisites are implicit in tooling (`backend/internal/database/test_helpers.go:18`, `:73`) but not documented in the contributor guides, leading to avoidable test failures.

### Solution

1. Update `README.md` in the “Available Make Targets / Development” section (`README.md:83`) with a short subsection, for example:
   ```markdown
   ### Database Tests

   The backend schema tests require:
   - PostgreSQL running at `postgres://ironarchive:ironarchive_password@localhost:5432/ironarchive?sslmode=disable`
   - The `migrate` CLI (`brew install golang-migrate` or see https://github.com/golang-migrate/migrate)

   Once prerequisites are ready:
   ```bash
   cd backend
   go test ./internal/database/...
   ```
   ```
2. Optionally, add `.tools/migrate.md` or a short snippet in `docs/development/database-testing.md` if the team prefers more detailed guidance.

### Verification Checklist

- [ ] README changes reviewed for clarity and accuracy.  
- [ ] Fresh contributor can follow the doc and run `go test ./internal/database/...` successfully.

---

## Final Validation Steps

After completing the improvements:

1. **Run Local Tests**
   ```bash
   make migrate-down
   make migrate-up
   cd backend
   go test ./internal/database/...
   ```
2. **Update Story 1.2 Artifacts**
   - Mark the concern resolved in `docs/stories/1.2.story.md` (QA Results “Highlights/Outstanding Concerns”).
   - Refresh the quality gate (`docs/qa/gates/1.2-database-schema-design-and-migration-system.yml`) to **PASS** or **EXCELLENT**.

3. **Notify QA**
   - Post the change summary and validation evidence so QA can perform the closure review.

---

## Summary

Resolving the tenant credential contract mismatch and documenting the test prerequisites removes all open quality concerns for Story 1.2. Completing the steps above prepares the story for a 100/100 gate decision and provides developers with a clear reference for future schema work.
